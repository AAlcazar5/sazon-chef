// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  password       String? // Hashed password (nullable for social login users)
  // Social login fields
  provider       String? // 'google', 'apple', or null for email/password
  providerId     String? // OAuth provider's user ID
  providerEmail  String? // Email from OAuth provider (may differ from email field)
  // Encryption metadata
  emailEncrypted Boolean  @default(false) // Whether email is encrypted
  nameEncrypted  Boolean  @default(false) // Whether name is encrypted
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Preferences and goals
  preferences     UserPreferences?
  macroGoals      MacroGoals?
  physicalProfile UserPhysicalProfile?

  // Relationships
  savedRecipes            SavedRecipe[]
  collections             Collection[]
  feedback                RecipeFeedback[]
  mealHistory             MealHistory[]
  mealPlans               MealPlan[]
  shoppingLists           ShoppingList[]
  shoppingAppIntegrations ShoppingAppIntegration[]
  ingredientCosts         IngredientCost[]
  // NEW: User-created recipes
  createdRecipes          Recipe[]
  // Meal prep portion tracking
  mealPrepPortions        MealPrepPortion[]
  mealPrepSessions        MealPrepSession[]
  mealPrepTemplates       MealPrepTemplate[]

  @@map("users")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Banned ingredients and preferences
  bannedIngredients   BannedIngredient[]
  likedCuisines       LikedCuisine[]
  dietaryRestrictions DietaryRestriction[]
  preferredSuperfoods PreferredSuperfood[] // Superfood preferences (Phase 6, Group 12a)
  cookTimePreference  Int // in minutes
  spiceLevel          String? // mild, medium, spicy

  // Cost tracking & budget preferences (Phase 6, Group 13)
  maxRecipeCost      Float? // Maximum cost per recipe
  maxMealCost        Float? // Maximum cost per meal
  maxDailyFoodBudget Float? // Maximum daily food budget
  currency           String? @default("USD")

  // Location preferences for store lookup
  zipCode             String? // User's zip code
  latitude            Float? // GPS latitude
  longitude           Float? // GPS longitude
  useLocationServices Boolean? @default(false) // Whether to use GPS location

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

// Separate tables for array-like fields
model BannedIngredient {
  id           String           @id @default(cuid())
  preference   UserPreferences? @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
  preferenceId String?
  name         String

  @@map("banned_ingredients")
}

model LikedCuisine {
  id           String           @id @default(cuid())
  preference   UserPreferences? @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
  preferenceId String?
  name         String

  @@map("liked_cuisines")
}

model DietaryRestriction {
  id           String           @id @default(cuid())
  preference   UserPreferences? @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
  preferenceId String?
  name         String

  @@map("dietary_restrictions")
}

model PreferredSuperfood {
  id           String           @id @default(cuid())
  preference   UserPreferences? @relation(fields: [preferenceId], references: [id], onDelete: Cascade)
  preferenceId String?
  category     String // Superfood category (e.g., "beans", "oliveOil", "salmon", etc.)

  @@map("preferred_superfoods")
}

model MacroGoals {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  calories Int
  protein  Int
  carbs    Int
  fat      Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("macro_goals")
}

model UserPhysicalProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Physical measurements
  gender   String // male, female, other
  age      Int
  heightCm Float // Height in centimeters
  weightKg Float // Weight in kilograms

  // Activity and goals
  activityLevel String // sedentary, lightly_active, moderately_active, very_active, extra_active
  fitnessGoal   String // lose_weight, maintain, gain_muscle, gain_weight

  // Calculated metrics (stored for tracking changes over time)
  bmr            Float? // Basal Metabolic Rate
  tdee           Float? // Total Daily Energy Expenditure
  targetWeightKg Float? // Target weight if applicable

  // Additional optional data for future metabolism tracking
  bodyFatPercentage Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_physical_profiles")
}

model Recipe {
  id          String  @id @default(cuid())
  title       String
  description String
  cookTime    Int // in minutes
  cuisine     String
  difficulty  String  @default("medium") // "easy", "medium", "hard"
  servings    Int     @default(1)
  imageUrl    String?

  // Unsplash attribution (required for production API compliance)
  unsplashPhotoId              String? // Unsplash photo ID
  unsplashDownloadLocation     String? // For triggering download events
  unsplashPhotographerName     String? // Photographer's name
  unsplashPhotographerUsername String? // Photographer's username
  unsplashAttributionText      String? // "Photo by {name} on Unsplash"
  unsplashUrl                  String? // Link to photo on Unsplash (hotlinked per guidelines)

  // Macro nutrients
  calories Int
  protein  Int
  carbs    Int
  fat      Int
  fiber    Int?
  sugar    Int?

  // NEW: Recipe ownership
  userId        String? // Null for system recipes, set for user-created recipes
  user          User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  isUserCreated Boolean @default(false)

  // Recipe source tracking
  source String @default("database") // "database", "user-created", "ai-generated", "external"

  // External data integration (Phase 5)
  externalId       String? // ID from external source (e.g., Spoonacular)
  externalSource   String? // Source name (e.g., "spoonacular", "edamam")
  qualityScore     Float? // Quality rating from external source (0-100)
  popularityScore  Float? // Popularity metric from external source (0-100)
  healthScore      Float? // Health score from external API
  aggregateLikes   Int? // Total likes/favorites from external source
  spoonacularScore Float? // Spoonacular-specific score
  pricePerServing  Float? // Cost per serving from external API
  sourceUrl        String? // Original recipe URL
  sourceName       String? // Original source attribution
  lastEnriched     DateTime? // Last time external data was fetched

  // Cost tracking (Phase 6, Group 13)
  estimatedCost           Float? // Estimated total cost of recipe
  estimatedCostPerServing Float? // Estimated cost per serving
  costSource              String? // "user", "api", "calculated", "estimated"

  // Meal prep suitability (Phase 6, Group 14)
  mealPrepSuitable    Boolean? @default(false) // General meal prep suitability
  freezable           Boolean? @default(false) // Can be frozen
  batchFriendly       Boolean? @default(false) // Good for batch cooking
  weeklyPrepFriendly  Boolean? @default(false) // Good for weekly meal prep
  mealPrepScore       Float? // 0-100 score for meal prep suitability
  
  // Storage instructions
  storageInstructions String? // Storage instructions (e.g., "Refrigerate for up to 5 days", "Freeze for up to 3 months")
  fridgeStorageDays   Int? // Number of days recipe can be stored in fridge
  freezerStorageMonths Int? // Number of months recipe can be stored in freezer
  shelfStable         Boolean? @default(false) // Can be stored at room temperature

  // Recipe content
  ingredients  RecipeIngredient[]
  instructions RecipeInstruction[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  feedback     RecipeFeedback[]
  savedRecipes SavedRecipe[]
  mealHistory  MealHistory[]
  meals        Meal[]
  mealPrepPortions MealPrepPortion[] // Meal prep portion tracking
  mealPrepTemplates MealPrepTemplate[] // Meal prep templates

  @@map("recipes")
}

model RecipeIngredient {
  id       String @id @default(cuid())
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId String
  text     String
  order    Int

  // Cost tracking (Phase 6, Group 13)
  estimatedCost Float? // Estimated cost for this ingredient
  unitCost      Float? // Cost per unit (e.g., per lb, per cup)

  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id       String @id @default(cuid())
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId String
  text     String
  step     Int

  @@map("recipe_instructions")
}

model RecipeFeedback {
  id       String @id @default(cuid())
  recipeId String
  userId   String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  liked    Boolean @default(false)
  disliked Boolean @default(false)
  saved    Boolean @default(false)
  consumed Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([recipeId, userId])
  @@map("recipe_feedback")
}

model SavedRecipe {
  id       String @id @default(cuid())
  recipeId String
  userId   String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  savedDate DateTime @default(now())

  // Many-to-many relationship with collections via RecipeCollection
  recipeCollections RecipeCollection[]

  @@unique([recipeId, userId])
  @@map("saved_recipes")
}

model Collection {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-many relationship with recipes via RecipeCollection
  recipeCollections RecipeCollection[]

  @@unique([userId, name])
  @@map("collections")
}

// Join table for many-to-many relationship between recipes and collections
model RecipeCollection {
  id            String      @id @default(cuid())
  savedRecipeId String
  collectionId  String
  savedRecipe   SavedRecipe @relation(fields: [savedRecipeId], references: [id], onDelete: Cascade)
  collection    Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  addedAt       DateTime    @default(now())

  @@unique([savedRecipeId, collectionId])
  @@map("recipe_collections")
}

model MealHistory {
  id       String @id @default(cuid())
  recipeId String
  userId   String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date     DateTime @default(now())
  consumed Boolean  @default(false)
  feedback String? // liked, disliked, null

  @@map("meal_history")
}

model MealPlan {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String?
  startDate DateTime
  endDate   DateTime

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meals Meal[]

  @@map("meal_plans")
}

model Meal {
  id         String   @id @default(cuid())
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  date     DateTime
  mealType String
  recipeId String?
  recipe   Recipe?  @relation(fields: [recipeId], references: [id])

  customName        String?
  customDescription String?
  customCalories    Int?
  customProtein     Float?
  customCarbs       Float?
  customFat         Float?

  isCompleted Boolean   @default(false)
  completedAt DateTime?

  rating Int?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("meals")
}

// Meal Prep Portion Tracking (Phase 6, Group 14)
model MealPrepPortion {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId   String
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  // Portion allocation
  totalServings      Int      // Total servings made
  servingsToFreeze   Int      // Number of servings frozen
  servingsForWeek    Int      // Number of servings for immediate use (refrigerated)
  
  // Current status
  frozenServingsRemaining  Int      @default(0) // How many frozen servings are left
  freshServingsRemaining   Int      @default(0) // How many fresh servings are left
  
  // Tracking
  prepDate           DateTime @default(now()) // When meal prep was done
  freezeDate         DateTime? // When portions were frozen
  expiryDate         DateTime? // When fresh portions expire
  freezerExpiryDate  DateTime? // When frozen portions expire
  
  // Notes
  notes              String?
  
  // Consumption tracking
  consumedPortions   MealPrepConsumption[]
  
  // Meal prep session (optional - links to scheduled prep session)
  mealPrepSessionId String?
  mealPrepSession   MealPrepSession? @relation(fields: [mealPrepSessionId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("meal_prep_portions")
}

// Meal Prep Session Planning (Phase 6, Group 14)
model MealPrepSession {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session scheduling
  scheduledDate      DateTime  // When the meal prep session is scheduled
  scheduledTime      String?    // Optional time (e.g., "10:00 AM")
  duration           Int?       // Estimated duration in minutes
  isCompleted        Boolean    @default(false)
  completedAt        DateTime?
  
  // Session details
  notes              String?
  recipes             MealPrepPortion[] // Recipes being prepped in this session
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("meal_prep_sessions")
}

// Meal Prep Recipe Templates (Phase 6, Group 14)
model MealPrepTemplate {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId   String
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  // Default meal prep configuration
  defaultServings      Int      // Default total servings for meal prep
  defaultServingsToFreeze   Int? // Default servings to freeze
  defaultServingsForWeek    Int? // Default servings for immediate use
  
  // Template metadata
  name                 String?  // Custom name for this template (e.g., "Weekly Batch")
  notes                String?  // Notes or tips for this meal prep
  isFavorite           Boolean  @default(false) // Quick access favorite
  
  // Usage tracking
  timesUsed            Int      @default(0) // How many times this template has been used
  lastUsed             DateTime? // Last time this template was used
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, recipeId]) // One template per recipe per user
  @@map("meal_prep_templates")
}

// Track consumption of meal prep portions
model MealPrepConsumption {
  id                String   @id @default(cuid())
  mealPrepPortionId  String
  mealPrepPortion    MealPrepPortion @relation(fields: [mealPrepPortionId], references: [id], onDelete: Cascade)
  
  servings           Int      // Number of servings consumed
  portionType        String   // "frozen" or "fresh"
  consumedDate       DateTime @default(now())
  notes              String?
  
  createdAt DateTime @default(now())

  @@map("meal_prep_consumption")
}

model ScoringWeights {
  id String @id @default(cuid())

  // Scoring weights (70% macros, 30% taste by default)
  macroWeight           Float @default(0.7)
  tasteWeight           Float @default(0.3)
  cookTimeWeight        Float @default(0.1)
  ingredientMatchWeight Float @default(0.1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scoring_weights")
}

model ShoppingList {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String   @default("My Shopping List")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ShoppingListItem[]

  @@map("shopping_lists")
}

model ShoppingListItem {
  id             String       @id @default(cuid())
  shoppingListId String
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  name           String
  quantity       String
  category       String?
  purchased      Boolean      @default(false)
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("shopping_list_items")
}

model ShoppingAppIntegration {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appName      String // e.g., "instacart", "walmart", "kroger"
  apiKey       String?
  accessToken  String?
  refreshToken String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, appName])
  @@map("shopping_app_integrations")
}

model IngredientCost {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredientName String
  unitCost       Float
  unit           String   @default("lb") // lb, oz, cup, piece, etc.
  store          String?
  location       String?
  lastUpdated    DateTime @default(now())
  createdAt      DateTime @default(now())

  @@map("ingredient_costs")
}
